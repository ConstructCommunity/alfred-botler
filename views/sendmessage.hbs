<h1 style="text-align: center">Send a message to a channel</h1>

<form id="form" method="post" class="ui form">
    <div class="field">
        <div class="ui fluid search selection dropdown">
            <input type="hidden" name="channel">
            <i class="dropdown icon"></i>
            <div class="default text">Select Channel</div>
            <div class="menu">
                {{#channels}}
                    <div class="item" data-value="{{id}}"><i class="hashtag icon"></i>{{name}}</div>
                {{/channels}}
            </div>
        </div>
    </div>

    <div class="fields">
        <div class="eight wide field">
            <div class="input" id='input'
                 contenteditable></div>
        </div>
        <div class="eight wide field">
            <div class="input" id='formattedMessage' readonly></div>
        </div>

        <input type='hidden' id='fake_textarea_content' name='message'/>
    </div>

    <div class="fields">
        <div class="fourteen wide field">
            <div class="ui fluid search selection dropdown">
                <input type="hidden" name="user" id="user">
                <i class="dropdown icon"></i>
                <div class="default text">Select User</div>
                <div class="menu">
                    {{#users}}
                        <div class="item" data-value="{{user.id}}"><i class="at icon"></i>{{user.username}}</div>
                    {{/users}}
                </div>
            </div>
        </div>
        <div class="two wide field">
            <div id="insert" class="ui button">insert</div>
        </div>
    </div>

    <input class="ui button" type="submit" value="Submit"/>
</form>

<style>
    .input {
        height: 150px;
        border: 1px solid rgba(34, 36, 38, .15);
        border-radius: .28571429rem
    }
</style>

<script>
    function format (text) {
        var userOrMember = /^(?:<@!?)?(\d{17,21})>?$/;

        text = text.replace(userOrMember, '@$1');

        return text;
    }

    $(document).ready(() => {
        $('.dropdown').dropdown();

        $('.ui.form').form({
            fields: {
                channel: 'empty',
                message: 'empty'
            }
        });

        $('#insert').on('click', () => {
            var user = $('#user').val();
            console.log('user', user);
            $('#input').val($('#input').val() + '<@' + user + '> ');
        });

        $('#input').on('input', () => {
            var value = $('#input').text();
            var newvalue = format(value);
            $('#formattedMessage').text(newvalue);
        });

        $('#form').submit(() => {
            $('#fake_textarea_content').val($('#input').html());
        });
    });

</script>